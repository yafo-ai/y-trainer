<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模型微调</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="plugin/select2.min.css">
    <script src="plugin/jquery-3.6.0.min.js"></script>
    <script src="plugin/select2.min.js"></script>

    <script src="plugin/json-viewer/jquery.json-viewer.js"></script>
    <link href="plugin/json-viewer/jquery.json-viewer.css" type="text/css" rel="stylesheet">


    <link rel="stylesheet" href="styles/generation.css">
    <link rel="stylesheet" href="styles/model.css">

</head>

<body>
    <!-- Floating background elements -->
    <div class="floating-elements">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>

    <!-- Header navigation -->
    <nav class="header-nav">
        <div class="nav-container">
            <div class="logo">Y-Trainer</div>
            <ul class="nav-links">
                <li><a href="index.html" class="nav-link">首页</a></li>
                <li><a href="model.html" class="nav-link active">模型微调</a></li>
                <li><a href="attention.html" class="nav-link">注意力分析</a></li>
                <li><a href="compression.html" class="nav-link">内容压缩</a></li>
                <li><a href="generation.html" class="nav-link">样本生成</a></li>
                <li><a href="clustering.html" class="nav-link">聚类筛选</a></li>

            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="main-layout">
            <!-- Main Content -->
            <main class="main-content">
                
                <div class="config-panel evaluate_loss">
                    <div class="config-header">
                        
                    <h1 class="module-title">
                        <i class="fas fa-star-half-alt"></i>
                        训练语料评估 
                    </h1>
                     <label class="param-label">语料质量评估工具：分数越高学习困难度越大，需要排查语料中存在的问题。（非必要过程，但是建议先评估后训练）</label>
                    
                    </div>
                    <div class="config-content">
                        <div class="params-column">
                            <div class="params-grid">
                                <div class="param-group">
                                    <label class="param-label"><span class="c-danger">*</span>模型路径</label>
                                    <input type="text" class="param-input" name="model_path" placeholder="" value="">
                                </div>

                                <div class="param-group">
                                    <label class="param-label"><span class="c-danger">*</span>要评估语料路径：必须是包含文件名的完整路径</label>
                                    <input type="text" class="param-input" name="data_path" placeholder="" value="">
                                </div>

                                <div class="param-group">
                                    <label class="param-label">选择算法</label>
                                    <select id="my-select3" name="method" style="max-width: 340px;" class="param-input">
                                        <!-- 更多选项 -->
                                        <option value="">请选择</option>
                                        <option value="similarity_rank">similarity_rank</option>
                                        <option value="filtered_rank">filtered_rank</option>
                                    </select>
                                </div>

                                <div class="param-group">
                                    <label class="param-label">&nbsp;</label>
                                    <div class="action-buttons">

                                        <button style="height: 28px;font-size: 12px;" class="btn btn-secondary"
                                            onclick="reset('evaluate_loss')">
                                            <i class="fas fa-redo"></i> 重置
                                        </button>
                                        <button style="height: 28px;font-size: 12px;" class="btn btn-primary"
                                            onclick="startExa()">
                                            <i class="fas fa-play"></i> 开始评估
                                        </button>
                                    </div>

                                </div>


                                <div class="param-group" >
                                    <label class="param-label">评估结果将保存到以下位置</label>
                                    <input type="text" class="param-input" disabled
                                            name="output_path" placeholder="" value="" readonly>
                                </div>
                                
                                <div class="param-group" >
                                    <label class="param-label">&nbsp;</label>
                                    <div class="flexbox">
                                        <button style="height: 28px;font-size: 12px;"
                                            class="btn btn-primary" onclick="evaluate_resultfn()">
                                            查看结果
                                        </button>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>



                <div class="module-header sub-module-nav-md">
                    <h1 class="module-title">
                        <i class="fas fa-band-aid"></i>
                        模型微调
                    </h1>
                    <div style="display: none;" class="model-selector-container">
                        <label for="modelSelect">模型:</label>
                        <select id="modelSelect" class="model-select">
                        </select>
                        <div class="model-dropdown" id="modelDropdown">
                            <div class="model-current">
                                <i class="fas fa-robot"></i>
                                <span class="model-name">选择模型</span>
                                <i class="fas fa-chevron-down caret"></i>
                            </div>
                            <div class="model-menu">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sub Module Navigation -->

                <div class="sub-module-nav">
                    <div class="sub-module-buttons training_type">
                        <button class="sub-module-btn active" data-val="sft">
                            <i class="fas fa-chart-bar"></i> 指令微调（SFT）
                        </button>
                        <button class="sub-module-btn" data-val="cpt">
                            <i class="fas fa-chart-line"></i> 预训练（CPT）
                        </button>

                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="window.location.reload()">
                            <i class="fas fa-redo"></i> 重置
                        </button>
                        <button class="btn btn-primary" onclick="subfn()">
                            <i class="fas fa-play"></i> 开始训练
                        </button>
                    </div>

                </div>

                <div class="config-panel start_train">
                    <div class="config-header">
                        <i class="fas fa-sliders-h"></i>
                        模型配置

                    </div>
                    <div class="config-content">
                        <div class="params-column">
                            <div class="params-grid">
                                <div class="param-group">
                                    <label class="param-label"> <span class="c-danger">*</span> 要训练的模型：请将模型文件放入big-models目录下
                                        <span onclick="copyfn('#model_path_to_load')" class="c-primary-btn">复制</span>
                                    </label>
                                    <select style="max-width: 340px;" class="param-input" id="model_path_to_load"
                                        name="model_path_to_load">
                                        <option value="">请选择</option>
                                    </select>
                                </div>

                                <div class="param-group">
                                    <label class="param-label">精度</label>
                                    <div class="flexbox">
                                        <label class="item">
                                            <input type="radio" name="data_type" value="float16">
                                            float16
                                        </label>
                                        <label class="item">
                                            <input type="radio" name="data_type" value="float32">
                                            float32
                                        </label>
                                        <label class="item">
                                            <input type="radio" checked name="data_type" value="bfloat16">
                                            bfloat16
                                        </label>
                                    </div>
                                </div>

                                <div class="param-group">
                                    <label class="param-label">是否启用梯度检查点</label>
                                    <div class="flexbox">

                                        <div style="min-width: 40px;" class="toggle-container">
                                            <span class="toggle-text"></span>
                                            <label class="toggle">
                                                <input type="checkbox" checked name="gradit_checkpoing">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>

                                    </div>
                                </div>

                                <div class="param-group">
                                    <label class="param-label">deepSeed 多卡分布式训练</label>
                                    <div class="flexbox">

                                        <div style="min-width: 40px;" class="toggle-container">
                                            <span class="toggle-text"></span>
                                            <label class="toggle">
                                                <input type="checkbox" name="use_deepspeed">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>

                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-panel start_train">
                    <div class="config-header">
                        <i class="fas fa-sliders-h"></i>
                        Lora配置

                    </div>
                    <div class="config-content">
                        <div class="params-column">
                            <div class="params-grid">
                                <div class="param-group">
                                    <label class="param-label">是否使用lora微调</label>
                                    <div class="flexbox">
                                        <div style="min-width: 40px;" class="toggle-container">
                                            <span class="toggle-text"></span>
                                            <label class="toggle">
                                                <input type="checkbox" name="use_lora" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>

                                    </div>
                                </div>

                                <div class="param-group">
                                    <label class="param-label">要加载的lora路径 <span
                                            title="如果需要基于已训练lora继续训练，请在此处填写上一个lora的保存路径"
                                            class="far fa-question-circle"></span></label>
                                    <div class="flexbox">
                                        <input style="width: calc(100% - 100px);" type="text" class="param-input"
                                            name="lora_path" placeholder="" value="">
                                        <button style="height: 28px;width: 80px;margin-left: 20px;font-size: 12px;"
                                            class="btn btn-primary" onclick="getLora()">
                                            加载参数
                                        </button>
                                    </div>
                                </div>
                                <div class="param-group"></div>
                                <div class="param-group"></div>





                                <div class="param-group isloraPathHide">
                                    <label class="param-label"> <span class="c-danger">*</span> lora_rank <span
                                            title="rank 越高，LoRA适配器能够学习到的权重更新越复杂，可能带来更好的微调效果"
                                            class="far fa-question-circle"></span></label>
                                    <input type="number" class="param-input" name="lora_rank" value="16">

                                </div>

                                <div class="param-group isloraPathHide">
                                    <label class="param-label"> <span class="c-danger">*</span> lora_alpha <span
                                            title="适应强度：alpha 越大，LoRA适配器的贡献越大，模型更倾向于学习新任务的模式；alpha 越小，模型更依赖原始预训练权重。"
                                            class="far fa-question-circle"></span></label>
                                    <input type="number" class="param-input" name="lora_alpha" value="32">

                                </div>

                                <div class="param-group isloraPathHide">
                                    <label class="param-label"> <span class="c-danger">*</span> lora_dropout<span
                                            title="防止过拟合：较高的 dropout（如0.2-0.5）可以增强模型的泛化能力，尤其适用于数据量较小或任务复杂的场景。"
                                            class="far fa-question-circle"></span></label>
                                    <input type="number" class="param-input" name="lora_dropout" value="0.2">

                                </div>

                                <div class="param-group isloraPathHide">
                                    <label class="param-label"> <span class="c-danger">*</span> lora_target_modules<span
                                            title="需要应用 LoRA 的目标模块列表" class="far fa-question-circle"></span>
                                        <span onclick="setVal()" class="c-primary-btn">使用默认值</span>
                                    </label>

                                    <!-- <select multiple="multiple" id="my-select">
                                    </select> -->

                                    <input type="text" id="my-select" class="param-input" name="lora_target_modules"
                                        placeholder="用英文逗号分割（q_proj, v_proj, k_proj, o_proj, gate_proj, up_proj, down_proj）"
                                        value="">



                                </div>


                            </div>
                        </div>
                    </div>
                </div>


                <div class="config-panel start_train">
                    <div class="config-header">
                        <i class="fas fa-sliders-h"></i>
                        训练配置

                    </div>
                    <div class="config-content">
                        <div class="params-column">
                            <div class="params-grid">


                                <div class="param-group">
                                    <label class="param-label">开启nlirg算法(核心算法，默认启用)</label>
                                    <div class="flexbox">


                                        <div style="min-width: 40px;" class="toggle-container">
                                            <span class="toggle-text"></span>
                                            <label class="toggle">
                                                <input type="checkbox" name="use_nlirg" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>

                                    </div>
                                </div>


                                <div class="param-group">
                                    <label class="param-label"> <span class="c-danger">*</span> 数据路径 <span
                                            style="margin-left: 50px;"><span class="c-danger">*</span>数据集</span> <span
                                            onclick="copyfn('#data_path_select')"
                                            class="c-primary-btn">复制</span></label>
                                    <div class="flexbox">
                                        <input onblur="getdata_path()" style="width: calc(100% - 230px);" type="text"
                                            class="param-input" name="data_path_first" placeholder="" value="./data">
                                        <select style="width: 160px" class="param-input"
                                            id="data_path_select" multiple name="data_path">

                                        </select>
                                        <button style="height: 28px;width: 60px;margin-left: 10px;font-size: 12px;"
                                            class="btn btn-primary" onclick="getdataset()">
                                            预览
                                        </button>
                                    </div>
                                </div>



                                <div class="param-group">
                                    <label class="param-label"> <span class="c-danger">*</span> 训练轮数</label>
                                    <input type="number" class="param-input" name="epoch" value="3">
                                </div>


                                <div class="param-group">
                                    <label class="param-label"> <span class="c-danger">*</span>
                                        token_batch(每批几个token)<span
                                            title="数量越大速度越快，但是效果越差，建议设置为10，最大不要超过20" class="far fa-question-circle"></span></label>
                                    <input type="number" class="param-input" name="token_batch" value="10">
                                </div>




                                <div class="param-group">
                                    <label class="param-label"> <span class="c-danger">*</span> 批次大小</label>
                                    <input type="number" disabled class="param-input" name="batch_size" value="1">
                                </div>

                                <div class="param-group">
                                    <label class="param-label"> <span class="c-danger">*</span> 学习率</label>
                                    <input type="number" class="param-input" name="lr" value="5e-6">
                                </div>


                                <div class="param-group">
                                    <label class="param-label"> <span class="c-danger">*</span> 序列最大长度</label>
                                    <input type="number" class="param-input" name="max_seq_len" value="20520">
                                </div>


                                <div class="param-group">
                                    <label class="param-label"> <span class="c-danger">*</span> (预训练)pack_length</label>
                                    <input type="number" disabled class="param-input" name="pack_length" value="20520">
                                </div>


                                <div class="param-group">
                                    <label class="param-label">需要保存的检查点（输入数字回车即可）</label>

                                    <select multiple="multiple" name="checkpoint_epoch" id="checkpoint-select">
                                        <!-- 更多选项 -->
                                    </select>

                                </div>

                                <div class="param-group">
                                    <label class="param-label"> <span class="c-danger">*</span> 训练权重文件的保存路径</label>
                                    <input type="text" class="param-input" name="output_dir" placeholder="" value="./saved_models">
                                </div>



                                <div class="param-group">
                                    <label class="param-label">TensorBoard日志保存路径</label>
                                    <input type="text" class="param-input" name="tensorboard_path" placeholder=""
                                        value="">
                                </div>

                                <div class="param-group">
                                    <label class="param-label">默认系统提示词</label>
                                    <input type="text" class="param-input" name="system_prompt" placeholder=""
                                        value="You are a helpful assistant.">
                                </div>






                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-panel">
                    <div class="config-header">
                        <i class="fas fa-sliders-h"></i>
                        微调进度

                    </div>
                    <div class="config-content">
                        <div class="terminal-body">
                            <div id="terminal-output" class="terminal-output"></div>
                        </div>
                        <!-- <div id="output" style="
                    border: 1px solid #ccc; 
                    height: 500px; 
                    overflow-y: auto; 
                    padding: 10px; 
                    background: #000; 
                    color: #0f0; 
                    font-family: monospace;
                    white-space: pre-wrap;
                "></div> -->

                    </div>
                </div>


                <div class="config-panel merge_models">
                    <div class="config-header">
                        <h1 class="module-title">
                            <i class="fas fa-puzzle-piece"></i>
                            Lora合并工具
                        </h1>


                    </div>
                    <div class="config-content">
                        <div class="params-column">
                            <div class="params-grid">
                                <div class="param-group">
                                    <label class="param-label">基座模型路径</label>
                                    <input type="text" class="param-input" name="base_model_path" placeholder=""
                                        value="">
                                </div>

                                <div class="param-group">
                                    <label class="param-label">Lora路径</label>

                                    <input type="text" class="param-input" name="lora_path" placeholder="" value="">

                                </div>

                                <div class="param-group">
                                    <label class="param-label">合并后的模型路径</label>
                                    <input type="text" class="param-input" name="output_path" placeholder="" value="">
                                </div>

                                <div class="param-group">
                                    <label class="param-label">&nbsp;</label>
                                    <div class="action-buttons">
                                        <button style="height: 28px;font-size: 12px;" class="btn btn-secondary"
                                            onclick="reset('merge_models')">
                                            <i class="fas fa-redo"></i> 重置
                                        </button>
                                        <button style="height: 28px;font-size: 12px;" class="btn btn-primary"
                                            onclick="startMerge()">
                                            <i class="fas fa-play"></i> 开始合并
                                        </button>
                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>
                </div>


            </main>
        </div>
    </div>

    <div class="js-jsonbox">
        <div class="jsonrbox">
            <pre id="json-renderer"></pre>
        </div>
        <div class="btnbox">
            <button class="btn btn-primary" onclick="closeJson()">
                关闭
            </button>
        </div>
    </div>






    <script src="scripts/config.js"></script>
    <!-- <script src="scripts/model.js"></script> -->

    <script>



        var outputDiv = document.getElementById('output');
        var eventSource = null;

        let ws;
        let autoScroll = true;

        // 存储进度条元素
        const progressBars = new Map();

        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // let host = '192.168.50.109:8010';
            let host = window.location.host;
            const wsUrl = `${protocol}//${host}/api/train/ws/terminal`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {

                addTerminalLine('WebSocket连接已建立，开始接收终端输出...', 'system');
            };

            ws.onmessage = (event) => {
                addTerminalLine(event.data, 'output');
                // try {
                //     // 尝试解析为JSON对象，判断是否为进度条消息
                //     const message = JSON.parse(event.data);
                //     if (message.type === 'progress') {
                //         handleProgressMessage(message);
                //     } else {
                //         addTerminalLine(event.data, 'output');
                //     }
                // } catch (e) {
                //     // 不是JSON格式，作为普通文本处理
                //     addTerminalLine(event.data, 'output');
                // }
            };

            ws.onclose = () => {

                addTerminalLine('WebSocket连接已断开，5秒后尝试重连...', 'system');
                setTimeout(initWebSocket, 5000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket错误:', error);
                addTerminalLine('WebSocket连接错误', 'error');
            };
        }
        initWebSocket();


        function addTerminalLine(text, type = 'output') {
            const terminalOutput = document.getElementById('terminal-output');
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;

            // 处理ANSI颜色码（简单支持）
            text = text.replace(/\u001b\[32m([^\u001b]+)\u001b\[0m/g, '<span style="color: #4ec9b0;">$1</span>');
            text = text.replace(/\u001b\[31m([^\u001b]+)\u001b\[0m/g, '<span style="color: #f48771;">$1</span>');
            text = text.replace(/\u001b\[34m([^\u001b]+)\u001b\[0m/g, '<span style="color: #569cd6;">$1</span>');
            text = text.replace(/\u001b\[36m([^\u001b]+)\u001b\[0m/g, '<span style="color: #9cdcfe;">$1</span>');
            text = text.replace(/\u001b\[90m([^\u001b]+)\u001b\[0m/g, '<span style="color: #858585;">$1</span>');

            line.innerHTML = text;
            terminalOutput.appendChild(line);

            // 自动滚动到底部
            if (autoScroll) {
                scrollToBottom();
            } else {
                // 显示滚动按钮
                document.getElementById('scroll-to-bottom').classList.remove('hidden');
            }
        }


        // 处理进度条消息
        function handleProgressMessage(message) {
            const { guid, content } = message;
            const terminalOutput = document.getElementById('terminal-output');

            // 清理tqdm输出：移除ANSI颜色码和控制字符
            function cleanTqdmOutput(text) {
                // 移除ANSI颜色码
                let cleaned = text.replace(/\u001b\[[0-9;]*m/g, '');
                // 移除回车符（保留换行符）
                cleaned = cleaned.replace(/\r/g, '');
                // 移除多余的空行
                cleaned = cleaned.trim();
                return cleaned;
            }

            const cleanedContent = cleanTqdmOutput(content);

            // 检查是否已有该GUID的进度条
            if (progressBars.has(guid)) {
                // 更新现有进度条
                const progressElement = progressBars.get(guid);
                // 只更新内容，不重新创建元素
                const lineElement = progressElement.querySelector('.terminal-line');
                if (lineElement) {
                    lineElement.textContent = cleanedContent;
                }
            } else {
                // 创建新的进度条容器
                const progressContainer = document.createElement('div');
                progressContainer.id = `progress-${guid}`;
                progressContainer.className = 'progress-container';

                // 创建进度条行
                const line = document.createElement('div');
                line.className = 'terminal-line output';
                line.textContent = cleanedContent;
                progressContainer.appendChild(line);

                // 添加到终端输出
                terminalOutput.appendChild(progressContainer);
                // 存储进度条元素
                progressBars.set(guid, progressContainer);
            }

            // 自动滚动到底部
            if (autoScroll) {
                scrollToBottom();
            }
        }


        function scrollToBottom() {
            const terminalBody = document.querySelector('.terminal-body');
            terminalBody.scrollTop = terminalBody.scrollHeight;
            // document.getElementById('scroll-to-bottom').classList.add('hidden');
        }




        function sendWsMsg(msg) {
            eventSource.send(JSON.stringify({
                type: "feedback_score",
                data: {
                    id: '1',
                },
            }))
        }



        function closeStream() {
            eventSource && eventSource.close();
        }

        function clearOutput() {
            outputDiv.textContent = '';
        }

        function getdataset() {
            var path = $('.start_train [name="data_path"]').val();
            if (!path) return;
            $ajax('/api/train/load_dataset', {
                data_path: path,
            }, function (resData) {
                if (resData.code == 200 && resData.data) {
                    showJson(resData.data);
                }
            })
        }

        function evaluate_resultfn(){
            var path = $('.evaluate_loss [name="output_path"]').val();
            if (!path) return;
            $ajax('/api/train/evaluate_result', {
                output_path: path,
            }, function (resData) {
                if (resData.code == 200 && resData.data) {
                    showJson(resData.data);
                }
            })
        }

        function showJson(json) {
            $('#json-renderer').jsonViewer(json, {
                withLinks: false,        // 显示链接
                collapsed: false,       // 折叠所有节点
                rootCollapsable: false,           // 根节点是否可折叠
                withQuotes: false,                // 显示引号

                bigNumbers: true,
            });
            $('.js-jsonbox').show();
        }

        function closeJson() {
            $('.js-jsonbox').hide();
        }


        function checkParams(params) {
            // 校验参数
            if (!params.model_path_to_load) {
                alert('请选择要训练的模型');
                return false;
            }

            if (!params.lora_path && params.use_lora) {
                // 校验参数
                if (!params.lora_rank || !params.lora_alpha || !params.lora_dropout || !params.lora_target_modules) {
                    alert('lora_rank,lora_alpha,lora_dropout,lora_target_modules不能为空');
                    return false;
                }
            }

            if (params.use_nlirg) {
                if (!params.data_path) {
                    alert('数据集路径不能为空');
                    return false;
                }
                if (!params.epoch) {
                    alert('训练轮数不能为空');
                    return false;
                }
                if (!params.token_batch) {
                    alert('token_batch不能为空');
                    return false;
                }
                if (!params.batch_size) {
                    alert('批次大小不能为空');
                    return false;
                }
                if (!params.lr) {
                    alert('学习率不能为空');
                    return false;
                }
                if (!params.max_seq_len) {
                    alert('序列最大长度不能为空');
                    return false;
                }

                if (!params.pack_length) {
                    alert(' (预训练)pack_length不能为空');
                    return false;
                }

                if (!params.output_dir) {
                    alert('模型保存路径不能为空');
                    return false;
                }
            }

            return true;
        }


        function openloading() {
            var html = '<div class="c-loadingbox" style="position: fixed;left: 0;top: 0;right: 0;bottom: 0;background: rgba(255,255,255,0.85);display: flex;align-items: center;justify-content: center;z-index: 1111;"><div class="loading" style="transform: scale(1.5);"><div class="spinner"></div></div></div>'
        }

        function testOutput() {
            var params = {
                model_path_to_load: $('#model_path_to_load').val(),
                data_type: $('.start_train [name="data_type"]:checked').val(),
                lora_path: $('.start_train [name="lora_path"]').val(),
                lora_rank: $('.start_train [name="lora_rank"]').val(),
                lora_alpha: $('.start_train [name="lora_alpha"]').val(),
                lora_dropout: $('.start_train [name="lora_dropout"]').val(),
                epoch: $('.start_train [name="epoch"]').val(),
                lr: $('.start_train [name="lr"]').val(),
                lora_target_modules: $('#my-select').val() ? $('#my-select').val().split(/,|，|\s+/) : [],
                checkpoint_epoch: $('#checkpoint-select').val(),
                batch_size: $('.start_train [name="batch_size"]').val(),
                token_batch: $('.start_train [name="token_batch"]').val(),
                pack_length: $('.start_train [name="pack_length"]').val(),
                max_seq_len: $('.start_train [name="max_seq_len"]').val(),
                system_prompt: $('.start_train [name="system_prompt"]').val(),
                data_path: $('.start_train [name="data_path"]').val(),
                output_dir: $('.start_train [name="output_dir"]').val(),
                use_deepspeed: $('.start_train [name="use_deepspeed"]').prop('checked'),
                gradit_checkpoing: $('.start_train [name="gradit_checkpoing"]').prop('checked'),
                use_lora: $('.start_train [name="use_lora"]').prop('checked'),
                use_nlirg: $('.start_train [name="use_nlirg"]').prop('checked'),
                use_tensorboard: !!$('.start_train [name="tensorboard_path"]').val(),
                tensorboard_path: $('.start_train [name="tensorboard_path"]').val(),
                training_type: $('.training_type .sub-module-btn.active').attr('data-val'),
            }

            if (!checkParams(params)) {
                return false;
            }
            $ajax('/api/train/start_train', params, function (res) {
                if (res) {
                    // sendstrem();
                }
            })

        }







        function init() {
            $('#data_path_select').select2()
            getdata_path();
            $('.training_type .sub-module-btn').on('click', function () {
                $(this).addClass('active').siblings().removeClass('active');
                var curval = $(this).attr('data-val');
                if (curval == 'sft') {
                    $('.start_train input[name="pack_length"]').attr('disabled', true);
                    $('.start_train input[name="system_prompt"]').attr('disabled', false);
                } else {

                    $('.start_train input[name="pack_length"]').attr('disabled', false);
                    $('.start_train input[name="system_prompt"]').attr('disabled', true);
                }
            })

            $('.start_train input[name="use_deepspeed"]').on('change', function () {
                var isChecked = $(this).prop('checked');
                if (isChecked) {
                    // 多卡分布式训练  启用 需要保存的检查点 禁用
                    $('#checkpoint-select').attr('disabled', true);
                } else {
                    $('#checkpoint-select').attr('disabled', false);
                }
            })

            $('.start_train input[name="use_nlirg"]').on('change', function () {
                var isChecked = $(this).prop('checked');
                if (isChecked) {
                    //开启nlirg算法(核心算法，默认启用) q  批次大小 互斥
                    $('.start_train input[name="batch_size"]').attr('disabled', true);
                    $('.start_train input[name="token_batch"]').attr('disabled', false);

                } else {
                    $('.start_train input[name="token_batch"]').attr('disabled', true);
                    $('.start_train input[name="batch_size"]').attr('disabled', false);
                }
            })

            $('.start_train input[name="lora_path"]').on('input', function () {
                if ($(this).val()) {
                    //要加载的lora路径有值  下面4个全部清空 禁用
                    $('.start_train input[name="lora_rank"]').val('').attr('disabled', true);
                    $('.start_train input[name="lora_alpha"]').val('').attr('disabled', true);
                    $('.start_train input[name="lora_dropout"]').val('').attr('disabled', true);
                    $('.start_train input[name="lora_target_modules"]').val('').attr('disabled', true);
                } else {
                    $('.start_train input[name="lora_rank"]').val('16').attr('disabled', false);
                    $('.start_train input[name="lora_alpha"]').val('32').attr('disabled', false);
                    $('.start_train input[name="lora_dropout"]').val('0.2').attr('disabled', false);
                    $('.start_train input[name="lora_target_modules"]').val('').attr('disabled', false);
                }
            })

            // 监听epoch输入框的变化，动态更新checkpoint_epoch下拉框
            $('.start_train input[name="epoch"]').on('input change', function () {
                var epochValue = parseInt($(this).val());
                if (!isNaN(epochValue) && epochValue > 0) {
                    // 创建从0开始到epochValue-1的数组
                    var arr = [];
                    for (var i = 0; i < epochValue; i++) {
                        arr.push(i.toString());
                    }
                    // 更新下拉框选项
                    initSelect(arr, $('#checkpoint-select'));
                } else {
                    // 如果输入无效或为0，提供默认选项
                    initSelect(["0"], $('#checkpoint-select'));
                }
            });

            $('.start_train input[name="isloraPath"]').on('change', function () {
                var isChecked = $(this).prop('checked');
                if (isChecked) {
                    $('.start_train input[name="lora_path"]').show();
                    $('.start_train .isloraPathHide').hide();
                } else {
                    $('.start_train input[name="lora_path"]').hide().val('');
                    $('.start_train .isloraPathHide').show();
                }
            })
            $ajaxGet('/api/base/get_models', null, function (res) {

                if (res.code == 200 && res.data && res.data.model_name) {
                    let model_names = res.data.model_name;
                    for (let i = 0; i < model_names.length; i++) {
                        let item = model_names[i];
                        $('#model_path_to_load').append('<option value="' + item + '">' + item + '</option>');
                    }
                } else {
                    alert(res.message)
                }
            })

            // 初始化下拉选择框内容
            var epochValue = parseInt($('.start_train input[name="epoch"]').val()) || 3;
            var arr1 = [];
            for (var i = 0; i < epochValue; i++) {
                arr1.push(i.toString());
            }
            initSelect(arr1, $('#checkpoint-select'))

            // var arr = ["q_proj", "v_proj", "k_proj", "o_proj", "gate_proj", "up_proj", "down_proj"];
            // initSelect(arr, $('#my-select'))

            // 选择算法设置
            // var arr3 = ["similarity_rank", "filtered_rank"];
            // initSelect(arr3, $('#my-select3'))
        }


        function getLora() {
            var path = $('.start_train input[name="lora_path"]').val();
            if (!path) return false;
            $ajax('/api/train/load_lora_config', {
                lora_path: path,
            }, function (resData) {
                if (resData.code == 200 && resData.data) {
                    let res = resData.data;
                    $('.start_train input[name="lora_rank"]').val(res.lora_rank).attr('disabled', true);
                    $('.start_train input[name="lora_alpha"]').val(res.lora_alpha).attr('disabled', true);
                    $('.start_train input[name="lora_dropout"]').val(res.lora_dropout).attr('disabled', true);
                    $('.start_train input[name="lora_target_modules"]').val((res.target_modules ? res.target_modules.json(',') : '')).attr('disabled', true);
                }
            })

        }

        function setVal() {
            $('#my-select').val('q_proj,k_proj,v_proj,o_proj,gate_proj,up_proj,down_proj')
        }

        function getdata_path() {
            // 
            $('#data_path_select').html('');
            var path = $('.start_train input[name="data_path_first"]').val();
            
            if (!path) return false;
            $ajax('/api/train/list_dataset', {
                "data_dir": path,
            }, function (resData) {
                if (resData.code == 200 && resData.data) {
                    let arr = resData.data;
                    var mySelectHtml = '<option value="">请选择</option>';
                    for (var i = 0; i < arr.length; i++) {
                        var item = arr[i];
                        mySelectHtml += '<option value="' + item.data_path + '">' + item.name + '</option>';
                    }
                    $('#data_path_select').append(mySelectHtml);
                    setTimeout(function(){
                        $('#data_path_select').select2()
                    },100)
                }
            })

        }


        function copyfn(dom) {
            let val = $(dom).val();
            if (!val) return false;
            copyToClipboard(val, function () {
                alert('复制成功')
            })
        }


        function fallbackCopyTextToClipboard(text, fn) {
            // 创建一个文本框元素并设置其值为要复制的文本
            var textArea = document.createElement("textarea");
            textArea.value = text;

            // 将文本框置于页面外，使其不可见
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = "0";
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();



            try {
                var successful = document.execCommand('copy');
                if (fn) {
                    fn()
                } else if (successful) {
                    _this.$message('复制成功', 'success');
                }
                var msg = successful ? '成功' : '失败';
                console.log('文本 ' + msg + ' 复制到剪贴板');
            } catch (err) {
                console.error('无法复制文本', err);
            }

            document.body.removeChild(textArea);
        }

        function copyToClipboard(text, fn) {
            // 创建一个临时的输入框来存储文本
            if (navigator.clipboard && window.isSecureContext) {
                // 使用Clipboard API复制文本
                navigator.clipboard.writeText(text).then(function () {
                    if (fn) {
                        fn()
                    } else {
                        _this.$message('复制成功', 'success');
                    }
                }, function (err) {
                    console.error('无法复制文本: ', err);
                });
            } else {
                // 对于不支持Clipboard API的浏览器，使用后备方法
                fallbackCopyTextToClipboard(text, fn);
            }

        }


        function initSelect(arr, dom) {
            var mySelectHtml = '';
            for (var i = 0; i < arr.length; i++) {
                var item = arr[i];
                mySelectHtml += '<option value="' + item + '">' + item + '</option>';
            }
            dom.html(mySelectHtml);
            dom.select2({
                tags: true, // 启用标签支持
                createTag: function (params) {
                    // 检查输入是否为空，如果不是空字符串则创建标签
                    var term = $.trim(params.term);
                    if (term === '') {
                        return null;
                    }
                    return {
                        id: term,
                        text: term
                    };
                }
            });
        }


        function subfn() {

            testOutput();

        }


        function startMerge() {
            var params = {
                base_model_path: $('.merge_models [name="base_model_path"]').val(),
                lora_path: $('.merge_models [name="lora_path"]').val(),
                output_path: $('.merge_models [name="output_path"]').val(),
            }
            console.log(params)
            $ajax('/api/train/merge_models', params, function (res) {
                if (res) {
                    alert('合并成功')
                }
            })
        }
        function startExa() {
            var params = {
                data_path: $('.evaluate_loss [name="data_path"]').val(),
                model_path: $('.evaluate_loss [name="model_path"]').val(),
                method: $('#my-select3').val(),
                "sort": true
            }
            $ajax('/api/train/evaluate_loss', params, function (res) {
                if (res.code == 200 && res.data) {
                    $('.evaluate_loss [name="output_path"]').val(res.data.output_path)
                    alert('评估任务开启，请耐心等待。可在最下方控制台中查看进度。')
                }
            })
        }

        function reset(type) {

            if (type == 'evaluate_loss') {
                $('.evaluate_loss [name="data_path"]').val('');
                $('.evaluate_loss [name="model_path"]').val('');
                $('#my-select3').val('');
            } else {
                $('.merge_models [name="base_model_path"]').val('');
                $('.merge_models [name="lora_path"]').val('');
                $('.merge_models [name="output_path"]').val('');
            }
        }





        function $ajaxGet(url, data, sucfn, errfn) {
            var queryParams = data;
            var queryString = new URLSearchParams(queryParams).toString();
            var ajaxurl = url + (data ? '?' + queryString : '');
            fetch(ajaxurl)
                .then(async response => {
                    if (response.body && response.body.getReader) {
                        const reader = response.body.getReader();
                        let result = '';
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) {
                                break;
                            }
                            result += new TextDecoder().decode(value);
                        }
                        var res = JSON.parse(result);
                        if (res.code == 200) {
                            return res;
                        } else {
                            throw new Error(result);
                        }

                    } else if (response.status == 200) {
                        return response.json()
                    }

                })
                .then(data => {

                    sucfn && sucfn(data)
                })
                .catch(error => {
                    console.log(error, 'error');
                    try {
                        var errdata = JSON.parse(error.toString().replace(/^Error: /, ''));
                        if (errdata.code != 200 && errdata.message) {
                            alert(errdata.message)
                        }
                    } catch (err) {
                        console.log(err)
                    }

                    errfn && errfn(error)
                });
        }

        function $ajax(url, data, sucfn, errfn) {
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(async response => {
                    if (response.body && response.body.getReader) {
                        const reader = response.body.getReader();
                        let result = '';
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) {
                                break;
                            }
                            result += new TextDecoder().decode(value);
                        }
                        var res = JSON.parse(result);
                        if (res.code == 200) {
                            return res;
                        } else {
                            throw new Error(result);
                        }
                    } else if (response.status == 200) {
                        return response.json()
                    }
                })
                .then(data => {
                    sucfn && sucfn(data)
                })
                .catch(error => {
                    try {
                        var errdata = JSON.parse(error.toString().replace(/^Error: /, ''));
                        if (errdata.code != 200 && errdata.message) {
                            alert(errdata.message)
                        }
                    } catch (err) {
                        console.log(err)
                    }
                    errfn && errfn(error)
                });

        }



        $(function () {
            init();
        });
    </script>
</body>

</html>